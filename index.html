<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal PDF Inverter</title>
    <style>
        /* --- GLOBAL STYLES --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #121212; color: #e0e0e0; 
            margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; 
        }

        .container {
            width: 100%; max-width: 700px; background: #1e1e1e; 
            border-radius: 16px; padding: 30px 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center;
        }

        h1 { margin: 0 0 10px 0; color: #ffffff; font-size: 24px; }
        p.subtitle { color: #aaaaaa; font-size: 14px; margin-bottom: 30px; }

        /* --- BUTTONS --- */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        
        button {
            border: none; padding: 20px; border-radius: 12px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.2s, opacity 0.2s; color: white; width: 100%;
        }
        button:active { transform: scale(0.97); }
        button:hover { opacity: 0.9; }

        .icon { font-size: 24px; margin-bottom: 5px; }
        .label { font-size: 16px; font-weight: bold; }
        .desc { font-size: 11px; opacity: 0.8; margin-top: 4px; font-weight: normal; }

        /* Blue Button (Desktop/Zip) */
        .btn-zip { background: linear-gradient(135deg, #007acc, #005f9e); }
        
        /* Green Button (Mobile/Files) */
        .btn-files { background: linear-gradient(135deg, #28a745, #1e7e34); }

        /* --- STATUS & LIST --- */
        #status { margin-top: 20px; font-size: 15px; color: #ccc; white-space: pre-line; line-height: 1.5; }
        .success { color: #4ec9b0; font-weight: bold; }
        .error { color: #ff6b6b; }

        /* Mobile Download List (iPad Fix) */
        #file-list { list-style: none; padding: 0; margin-top: 20px; width: 100%; text-align: left; }
        .file-item {
            background: #2d2d2d; margin-bottom: 10px; padding: 15px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #333;
        }
        .file-name { font-size: 13px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 65%; }
        .save-btn {
            background: #007acc; color: white; text-decoration: none; padding: 8px 16px;
            border-radius: 6px; font-size: 13px; font-weight: bold;
        }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 600px) {
            .btn-group { grid-template-columns: 1fr; } /* Stack buttons on phone */
            .container { padding: 20px 15px; }
        }
    </style>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>

<div class="container">
    <h1>Universal Inverter</h1>
    <p class="subtitle">Secure â€¢ Offline â€¢ All Devices</p>

    <div class="btn-group">
        <button class="btn-zip" onclick="document.getElementById('folderInput').click()">
            <span class="icon">ðŸ“‚</span>
            <span class="label">Select Folder</span>
            <span class="desc">Best for PC (Downloads ZIP)</span>
        </button>

        <button class="btn-files" onclick="document.getElementById('fileInput').click()">
            <span class="icon">ðŸ“„</span>
            <span class="label">Select Files</span>
            <span class="desc">Best for iPad/Android</span>
        </button>
    </div>

    <input type="file" id="folderInput" webkitdirectory style="display:none">
    <input type="file" id="fileInput" multiple style="display:none">

    <div id="status">Ready</div>
    <ul id="file-list"></ul>
</div>

<script>
    const { PDFDocument, rgb, BlendMode } = PDFLib;
    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    // --- 1. CORE INVERT LOGIC (Used by both modes) ---
    async function invertPdf(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdfDoc = await PDFDocument.load(arrayBuffer);
        const pages = pdfDoc.getPages();

        for (const page of pages) {
            const { width, height } = page.getSize();
            page.drawRectangle({
                x: 0, y: 0, width, height,
                color: rgb(1, 1, 1),
                blendMode: BlendMode.Difference,
            });
        }
        return await pdfDoc.save();
    }

    // --- 2. ZIP MODE (PC/Folder Structure) ---
    async function processAsZip(files) {
        const status = document.getElementById('status');
        const list = document.getElementById('file-list');
        list.innerHTML = ""; // Clear list
        
        var zip = new JSZip();
        let count = 0;
        
        // Filter PDFs
        const pdfFiles = Array.from(files).filter(f => f.type === "application/pdf");
        if(pdfFiles.length === 0) { status.innerText = "No PDFs found."; return; }

        status.innerText = `Preparing to ZIP ${pdfFiles.length} files...`;

        for (const file of pdfFiles) {
            try {
                status.innerText = `Processing ${count + 1}/${pdfFiles.length}: ${file.name}`;
                const pdfBytes = await invertPdf(file);
                
                // Keep folder structure if possible
                const path = file.webkitRelativePath || file.name;
                zip.file(path, pdfBytes);
                count++;
            } catch (e) { console.error(e); }
        }

        status.innerText = "Zipping... (This might take a moment)";
        zip.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, "Dark_Notes.zip");
            status.innerHTML = `<span class="success">âœ” DONE! Saved 'Dark_Notes.zip'</span>`;
        });
    }

    // --- 3. INDIVIDUAL MODE (iPad/Android Safe) ---
    async function processAsIndividual(files) {
        const status = document.getElementById('status');
        const list = document.getElementById('file-list');
        list.innerHTML = ""; // Clear list
        
        const pdfFiles = Array.from(files).filter(f => f.type === "application/pdf");
        if(pdfFiles.length === 0) { status.innerText = "No PDFs selected."; return; }

        status.innerText = `Processing ${pdfFiles.length} files...`;

        for (let i = 0; i < pdfFiles.length; i++) {
            const file = pdfFiles[i];
            try {
                status.innerText = `Converting ${i + 1}/${pdfFiles.length}: ${file.name}`;
                
                const pdfBytes = await invertPdf(file);
                const blob = new Blob([pdfBytes], { type: "application/octet-stream" }); // 'octet-stream' forces download on Safari
                const newName = "DARK_" + file.name;
                const url = URL.createObjectURL(blob);

                // A. Add to Manual List (The iPad Fail-Safe)
                const li = document.createElement("li");
                li.className = "file-item";
                li.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <a href="${url}" download="${newName}" class="save-btn">Save PDF</a>
                `;
                list.appendChild(li);

                // B. Try Auto-Download (Best effort)
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = newName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }, 500); // Slight delay

                // Delay loop for next file
                await wait(800);

            } catch (e) { console.error(e); }
        }
        status.innerHTML = `<span class="success">âœ” Done! Check your downloads or use the buttons below.</span>`;
    }

    // --- LISTENERS ---
    document.getElementById('folderInput').addEventListener('change', (e) => {
        if(e.target.files.length > 0) processAsZip(e.target.files);
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
        if(e.target.files.length > 0) processAsIndividual(e.target.files);
    });
</script>

</body>
</html>
