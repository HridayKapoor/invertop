<!DOCTYPE html>
<html>
<head>
    <title>iPad PDF Inverter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #121212; color: #e0e0e0; text-align: center; padding: 20px; }
        
        .container { 
            max-width: 600px; margin: 0 auto; background: #1e1e1e; 
            padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        }

        /* Big Green Button for iPad */
        .btn-files { 
            background: linear-gradient(135deg, #28a745, #1e7e34); 
            padding: 20px; font-size: 18px; color: white; border: none; 
            border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer;
            margin-bottom: 20px;
        }

        #status { margin-top: 20px; color: #aaa; font-size: 14px; white-space: pre-line; }

        /* The List of Manual Download Links */
        #download-list { 
            list-style: none; padding: 0; margin-top: 20px; text-align: left; 
        }
        .download-item {
            background: #333; margin-bottom: 10px; padding: 15px; 
            border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
        }
        .file-name { font-size: 14px; color: #fff; max-width: 70%; overflow: hidden; text-overflow: ellipsis; }
        .save-btn {
            background: #007acc; color: white; text-decoration: none; 
            padding: 8px 15px; border-radius: 6px; font-size: 14px; font-weight: bold;
        }
    </style>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>

    <div class="container">
        <h2>iPad PDF Inverter</h2>
        <p style="color:#888; font-size:13px;">Files are processed offline.</p>

        <button class="btn-files" onclick="document.getElementById('fileInput').click()">
            ðŸ“„ Tap to Select Files
        </button>

        <input type="file" id="fileInput" multiple style="display:none">

        <h3 id="status">Ready</h3>
        
        <ul id="download-list"></ul>
    </div>

    <script>
        const { PDFDocument, rgb, BlendMode } = PDFLib;

        async function invertPdf(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await PDFDocument.load(arrayBuffer);
            const pages = pdfDoc.getPages();
            for (const page of pages) {
                const { width, height } = page.getSize();
                page.drawRectangle({
                    x: 0, y: 0, width, height,
                    color: rgb(1, 1, 1),
                    blendMode: BlendMode.Difference,
                });
            }
            return await pdfDoc.save();
        }

        async function processFiles(files) {
            const status = document.getElementById('status');
            const list = document.getElementById('download-list');
            
            status.innerText = `Processing ${files.length} files...`;
            list.innerHTML = ""; // Clear old list

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if(file.type !== "application/pdf") continue;

                try {
                    status.innerText = `Processing ${i + 1}/${files.length}: ${file.name}`;
                    
                    const pdfBytes = await invertPdf(file);
                    
                    // TRICK: Use 'application/octet-stream' to FORCE download on iPad
                    const blob = new Blob([pdfBytes], { type: "application/octet-stream" });
                    const url = URL.createObjectURL(blob);
                    const newName = "DARK_" + file.name;

                    // 1. Create a manual list item (Backup)
                    const li = document.createElement("li");
                    li.className = "download-item";
                    li.innerHTML = `
                        <span class="file-name">${newName}</span>
                        <a href="${url}" download="${newName}" class="save-btn">Save</a>
                    `;
                    list.appendChild(li);

                    // 2. Try Auto-Download (might be blocked, but we try)
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = newName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                } catch (e) { console.error(e); }
            }
            status.innerText = "Done! If downloads didn't start, tap 'Save' below.";
        }

        document.getElementById('fileInput').addEventListener('change', (e) => {
            if(e.target.files.length > 0) processFiles(e.target.files);
        });
    </script>
</body>
</html>
